<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.umd.js"></script>

    <style>
      /* ========== DESIGN SYSTEM ========== */
      :root {
        /* Palette principale */
        --bg-primary: #0a0e14;
        --bg-secondary: #13171e;
        --bg-card: rgba(25, 30, 40, 0.6);
        --bg-card-hover: rgba(30, 36, 48, 0.8);

        /* Couleurs d'accent dynamiques */
        --accent-primary: #4ecdc4;
        --accent-secondary: #a78bfa;
        --accent-warm: #ff6b9d;
        --accent-gradient: linear-gradient(
          135deg,
          var(--accent-primary),
          var(--accent-secondary)
        );

        /* Texte */
        --text-primary: #f8fafc;
        --text-secondary: #94a3b8;
        --text-muted: #64748b;

        /* Effets */
        --blur-sm: blur(8px);
        --blur-md: blur(16px);
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.15);
        --shadow-md: 0 4px 20px rgba(0, 0, 0, 0.25);
        --shadow-lg: 0 8px 40px rgba(0, 0, 0, 0.4);
        --shadow-glow: 0 0 30px rgba(78, 205, 196, 0.15);

        /* Spacing & Layout */
        --gap-sm: 0.75rem;
        --gap-md: 1.25rem;
        --gap-lg: 2rem;
        --radius-sm: 1rem;
        --radius-md: 1.5rem;
        --radius-lg: 2rem;

        /* Animations */
        --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        --ease-bounce: cubic-bezier(0.68, -0.55, 0.265, 1.55);
        --duration-fast: 0.2s;
        --duration-normal: 0.4s;
        --duration-slow: 0.8s;
      }

      /* ========== BASE STYLES ========== */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: var(--bg-primary);
        color: var(--text-primary);
        font-family: "Inter", -apple-system, system-ui, sans-serif;
        overflow: hidden;
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      /* Ambient background particles */
      body::before {
        content: "";
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
            circle at 20% 30%,
            rgba(78, 205, 196, 0.08) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(167, 139, 250, 0.06) 0%,
            transparent 50%
          ),
          radial-gradient(
            circle at 50% 50%,
            rgba(255, 107, 157, 0.04) 0%,
            transparent 50%
          );
        animation: ambient 20s ease-in-out infinite alternate;
        pointer-events: none;
      }

      @keyframes ambient {
        0% {
          transform: translate(0, 0) rotate(0deg);
        }
        100% {
          transform: translate(5%, 3%) rotate(5deg);
        }
      }

      /* ========== LAYOUT GRID ========== */
      .dashboard {
        display: grid;
        grid-template-columns: repeat(12, 1fr);
        grid-template-rows: repeat(10, 1fr);
        gap: var(--gap-md);
        padding: var(--gap-md);
        width: 100%;
        height: 100%;
        position: relative;
        z-index: 1;
      }

      /* ========== CARD BASE ========== */
      .card {
        background: var(--bg-card);
        backdrop-filter: var(--blur-md);
        -webkit-backdrop-filter: var(--blur-md);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: var(--radius-lg);
        padding: var(--gap-lg);
        box-shadow: var(--shadow-md);
        overflow: hidden;
        position: relative;
        transition: all var(--duration-normal) var(--ease-smooth);
        display: flex;
        flex-direction: column;
        min-height: 0; /* allow flex children to shrink inside grid cells */
        opacity: 0;
        transform: scale(0.95) translateY(10px);
      }

      .card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--accent-gradient);
        opacity: 0;
        transition: opacity var(--duration-normal);
        pointer-events: none;
        z-index: -1;
      }

      .card:not(.hidden) {
        animation: cardEnter var(--duration-slow) var(--ease-smooth) forwards;
      }

      .card.hidden {
        animation: cardExit var(--duration-normal) var(--ease-smooth) forwards;
        pointer-events: none;
      }

      /* Subtle breathing animation */
      @keyframes breathe {
        0%,
        100% {
          box-shadow: var(--shadow-md);
          transform: scale(1);
        }
        50% {
          box-shadow: var(--shadow-md), var(--shadow-glow);
          transform: scale(1.005);
        }
      }

      .card:not(.hidden):not(#musicCard) {
        animation: cardEnter var(--duration-slow) var(--ease-smooth) forwards,
          breathe 8s ease-in-out 1s infinite;
      }

      @keyframes cardEnter {
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      @keyframes cardExit {
        to {
          opacity: 0;
          transform: scale(0.9) translateY(-10px);
        }
      }

      /* ========== TIME CARD ========== */
      #timeCard {
        grid-column: 1 / 5;
        grid-row: 1 / 5;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: calc(var(--gap-md) * 1.25);
      }

      .time-display {
        font-size: clamp(2rem, 6vw, 4rem);
        font-weight: 700;
        letter-spacing: -0.03em;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 0 40px rgba(78, 205, 196, 0.3);
        animation: timeGlow 4s ease-in-out infinite;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      @keyframes timeGlow {
        0%,
        100% {
          filter: brightness(1);
        }
        50% {
          filter: brightness(1.2);
        }
      }

      /* ========== WEATHER CARD ========== */
      #weatherCard {
        grid-column: 1 / 5;
        grid-row: 5 / 11;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: calc(var(--gap-md) * 1.25);
      }

      .weather-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: var(--gap-lg);
        width: 100%;
        height: 100%;
      }

      .weather-icon {
        width: clamp(120px, 18vw, 180px);
        height: clamp(120px, 18vw, 180px);
        filter: drop-shadow(0 8px 20px rgba(78, 205, 196, 0.4));
        animation: weatherFloat 6s ease-in-out infinite;
      }

      @keyframes weatherFloat {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .weather-text {
        text-align: center;
        font-size: clamp(1.1rem, 2.5vw, 1.5rem);
        font-weight: 500;
        color: var(--text-secondary);
        line-height: 1.4;
      }

      .weather-temp {
        font-size: clamp(3rem, 6vw, 5rem);
        font-weight: 700;
        color: var(--text-primary);
        margin-top: 0.25rem;
        text-shadow: 0 2px 12px rgba(78, 205, 196, 0.3);
        width: 100%;
        display: flex;
        justify-content: center;
      }

      /* ========== FORECAST CARD (HERO) ========== */
      #forecastCard {
        grid-column: 5 / 13;
        grid-row: 1 / 5;
        display: flex;
        flex-direction: column;
        background: var(--bg-card-hover);
        border: 1px solid rgba(78, 205, 196, 0.15);
      }

      #forecastCard::before {
        opacity: 0.03;
      }

      .forecast-header {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--text-muted);
        margin-bottom: var(--gap-md);
      }

      .forecast-grid {
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: var(--gap-sm);
        flex: 1;
        align-items: stretch;
        height: 100%;
      }

      .forecast-item {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: var(--radius-md);
        padding: var(--gap-md);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--gap-sm);
        transition: all var(--duration-fast) var(--ease-smooth);
        height: 100%;
        justify-content: center;
      }

      .forecast-item:hover {
        background: rgba(255, 255, 255, 0.05);
        transform: translateY(-2px);
      }

      .forecast-time {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        letter-spacing: 0.05em;
      }

      .forecast-icon {
        width: 48px;
        height: 48px;
        filter: drop-shadow(0 2px 8px rgba(78, 205, 196, 0.2));
      }

      .forecast-temp {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-primary);
      }

      .forecast-desc {
        font-size: 0.7rem;
        color: var(--text-secondary);
        text-align: center;
        line-height: 1.3;
      }

      /* ========== MUSIC CARD ========== */
      #musicCard {
        grid-column: 5 / 13;
        grid-row: 5 / 11;
        flex-direction: row;
        align-items: center;
        justify-content: flex-start;
        gap: calc(var(--gap-lg) * 1.5);
        padding: calc(var(--gap-lg) * 1.5);
        background: rgba(255, 107, 157, 0.15);
        border: 1px solid rgba(255, 107, 157, 0.3);
      }

      #musicCard:not(.hidden) {
        animation: cardEnter var(--duration-slow) var(--ease-smooth) forwards;
      }

      #musicCard::before {
        opacity: 0.1;
      }

      .music-cover-wrapper {
        position: relative;
        flex-shrink: 0;
      }

      .music-cover {
        width: clamp(140px, 16vw, 200px);
        height: clamp(140px, 16vw, 200px);
        border-radius: var(--radius-lg);
        object-fit: cover;
        box-shadow: var(--shadow-lg), 0 0 40px rgba(255, 107, 157, 0.3);
        animation: coverPulse 3s ease-in-out infinite;
      }

      @keyframes coverPulse {
        0%,
        100% {
          transform: scale(1);
          box-shadow: var(--shadow-lg);
        }
        50% {
          transform: scale(1.02);
          box-shadow: var(--shadow-lg), 0 0 30px rgba(255, 107, 157, 0.4);
        }
      }

      .music-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: var(--gap-md);
        min-width: 0;
      }

      .music-track {
        font-size: clamp(1.75rem, 3.5vw, 2.75rem);
        font-weight: 700;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.2;
      }

      .music-artist {
        font-size: clamp(1.125rem, 2vw, 1.5rem);
        font-weight: 500;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        opacity: 0.9;
      }

      .music-progress {
        width: 100%;
        height: 6px;
        background: rgba(255, 255, 255, 0.12);
        border-radius: 6px;
        overflow: hidden;
        margin-top: var(--gap-md);
      }

      .music-progress-bar {
        height: 100%;
        background: var(--accent-gradient);
        border-radius: 2px;
        width: 0%;
        transition: width 200ms linear;
        box-shadow: 0 0 18px rgba(78, 205, 196, 0.28);
      }

      .music-progress-row {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
      }

      .music-duration {
        color: var(--text-secondary);
        font-size: 0.95rem;
        min-width: 48px;
        text-align: right;
        opacity: 0.95;
      }

      /* ========== RESPONSIVE ADJUSTMENTS ========== */
      @media (max-width: 1200px) {
        .forecast-grid {
          grid-template-columns: repeat(3, 1fr);
        }

        .forecast-item:nth-child(n + 4) {
          display: none;
        }
      }

      @media (max-height: 800px) {
        .dashboard {
          gap: var(--gap-sm);
          padding: var(--gap-md);
        }

        .card {
          padding: var(--gap-md);
        }
      }

      /* ========== UTILITY ========== */
      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <!-- TIME CARD -->
      <div id="timeCard" class="card hidden">
        <div class="time-display" id="time">00:00:00</div>
      </div>

      <!-- WEATHER CARD -->
      <div id="weatherCard" class="card hidden">
        <div class="weather-content">
          <img id="weatherIcon" src="" alt="weather" class="weather-icon" />
          <div>
            <div class="weather-text" id="weather">Chargement...</div>
            <div class="weather-temp" id="weatherTemp"></div>
          </div>
        </div>
      </div>

      <!-- FORECAST CARD (HERO) -->
      <div id="forecastCard" class="card hidden">
        <div class="forecast-header">Prévisions</div>
        <div class="forecast-grid" id="forecast"></div>
      </div>

      <!-- MUSIC CARD -->
      <div id="musicCard" class="card hidden">
        <div class="music-cover-wrapper">
          <img id="cover" src="" alt="Cover" class="music-cover" />
        </div>
        <div class="music-info">
          <div class="music-track" id="track">Titre</div>
          <div class="music-artist" id="artist">Artiste</div>
          <div class="music-progress-row">
            <div class="music-progress">
              <div class="music-progress-bar" id="progressBar"></div>
            </div>
            <div class="music-duration" id="musicDuration">0:00</div>
          </div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      // ========== CONFIGURATION ==========
      const config = {
        showTime: true,
        showWeather: true,
        showForecast: true,
        showSeconds: true,
      };

      // ========== DOM ELEMENTS ==========
      const timeEl = document.getElementById("time");
      const weatherEl = document.getElementById("weather");
      const weatherTempEl = document.getElementById("weatherTemp");
      const weatherIconEl = document.getElementById("weatherIcon");
      const timeCard = document.getElementById("timeCard");
      const weatherCard = document.getElementById("weatherCard");
      const musicCard = document.getElementById("musicCard");
      const forecastCard = document.getElementById("forecastCard");
      const forecastEl = document.getElementById("forecast");
      const trackEl = document.getElementById("track");
      const artistEl = document.getElementById("artist");
      const coverEl = document.getElementById("cover");
      const progressBar = document.getElementById("progressBar");
      const musicDurationEl = document.getElementById("musicDuration");

      // ========== INITIALIZATION ==========
      function init() {
        updateDisplay();
        if (config.showWeather) getWeather();
        if (config.showForecast) getForecast();
        startClock();
      }

      function updateDisplay() {
        // Délai progressif pour animation en cascade
        const cards = [
          { el: timeCard, show: config.showTime, delay: 0 },
          { el: weatherCard, show: config.showWeather, delay: 100 },
          { el: forecastCard, show: config.showForecast, delay: 200 },
        ];

        cards.forEach(({ el, show, delay }) => {
          setTimeout(() => {
            el.classList.toggle("hidden", !show);
          }, delay);
        });
      }

      // ========== CLOCK ==========
      function startClock() {
        function updateClock() {
          if (!config.showTime) return;
          const now = new Date();
          const opts = { hour: "2-digit", minute: "2-digit" };
          if (config.showSeconds) opts.second = "2-digit";
          timeEl.textContent = now.toLocaleTimeString([], opts);
        }
        updateClock();
        setInterval(updateClock, 1000);
      }

      // ========== WEATHER ==========
      function getWeather() {
        if (!config.showWeather) return;
        fetch("/api/weather")
          .then((res) => res.json())
          .then((data) => {
            weatherEl.textContent = `${data.name} · ${data.desc}`;
            weatherTempEl.textContent = `${data.temp}°C`;
            weatherIconEl.src = `/weather-icons/${data.icon}.svg`;
          })
          .catch(() => {
            weatherEl.textContent = "Erreur météo";
          });
      }

      // Refresh weather every 30min
      setInterval(() => {
        if (config.showWeather) getWeather();
      }, 30 * 60000);

      // ========== FORECAST ==========
      function getForecast() {
        if (!config.showForecast) return;

        fetch("/api/forecast")
          .then((res) => res.json())
          .then((data) => {
            forecastEl.innerHTML = "";
            data.list.forEach((f, index) => {
              const time = new Date(f.dt * 1000).toLocaleTimeString([], {
                hour: "2-digit",
                minute: "2-digit",
              });

              const item = document.createElement("div");
              item.className = "forecast-item";
              item.style.animationDelay = `${index * 50}ms`;
              item.innerHTML = `
                <div class="forecast-time">${time}</div>
                <img class="forecast-icon" src="/weather-icons/${
                  f.icon
                }.svg" alt="${f.description}" />
                <div class="forecast-temp">${Math.round(f.temp)}°C</div>
                <div class="forecast-desc">${f.description}</div>
              `;
              forecastEl.appendChild(item);
            });
          })
          .catch((err) => {
            console.error("Forecast error:", err);
          });
      }

      // Refresh forecast every hour
      setInterval(() => {
        if (config.showForecast) getForecast();
      }, 60 * 60000);

      // ========== MUSIC ==========
      let musicTimeout;
      let progressInterval;
      let musicStartTime;
      let musicInitialPosition = 0;
      let musicDuration = 0;

      socket.on("musicData", (data) => {
        // Clear previous timers
        if (musicTimeout) clearTimeout(musicTimeout);
        if (progressInterval) clearInterval(progressInterval);

        // Update music info
        trackEl.textContent = data.title;
        artistEl.textContent = data.artist;
        coverEl.src = data.cover || "";

        // Store timing
        musicInitialPosition = data.position || 0;
        musicDuration = data.duration || 0;
        // Afficher la durée totale formatée
        if (musicDurationEl)
          musicDurationEl.textContent = formatTime(musicDuration);
        musicStartTime = Date.now();

        // Extract dominant color from cover
        if (data.cover) {
          const img = new Image();
          img.crossOrigin = "Anonymous";
          img.src = data.cover;

          img.onload = () => {
            try {
              const colorThief = new ColorThief();
              const [r, g, b] = colorThief.getColor(img);
              const luminance = 0.299 * r + 0.587 * g + 0.114 * b;

              // Apply dynamic gradient
              musicCard.style.background = `
                linear-gradient(135deg, 
                  rgba(${r}, ${g}, ${b}, 0.3) 0%, 
                  rgba(${r * 0.7}, ${g * 0.7}, ${b * 0.7}, 0.2) 100%
                )
              `;

              // Adjust text color based on luminance
              const textColor = luminance > 128 ? "#0A0E14" : "#F8FAFC";
              trackEl.style.color = textColor;
              artistEl.style.color = textColor;
            } catch (e) {
              console.error("Color extraction failed:", e);
            }
          };
        }

        // Show music card with animation
        musicCard.classList.remove("hidden");

        // Smooth progress animation
        progressInterval = setInterval(() => {
          const elapsed = (Date.now() - musicStartTime) / 1000;
          const currentPosition = musicInitialPosition + elapsed;
          let progress = 0;
          if (musicDuration > 0) {
            progress = Math.min((currentPosition / musicDuration) * 100, 100);
          }
          progressBar.style.width = `${progress}%`;

          if (musicDuration > 0 && currentPosition >= musicDuration) {
            clearInterval(progressInterval);
            hideMusicCard();
          }
        }, 100); // Update every 100ms for smooth animation

        // Auto-hide when song ends
        const remaining = musicDuration - musicInitialPosition;
        if (remaining > 0) {
          musicTimeout = setTimeout(() => {
            hideMusicCard();
          }, remaining * 1000);
        }
      });

      function hideMusicCard() {
        musicCard.classList.add("hidden");
        if (progressInterval) clearInterval(progressInterval);
        progressBar.style.width = "0%";
        if (musicDurationEl) musicDurationEl.textContent = "0:00";
      }

      function formatTime(seconds) {
        if (!seconds || isNaN(seconds) || seconds <= 0) return "0:00";
        const s = Math.floor(seconds % 60);
        const m = Math.floor(seconds / 60);
        return `${m}:${s.toString().padStart(2, "0")}`;
      }

      // ========== START ==========
      init();
    </script>
  </body>
</html>
